# RotorNet Packet-Level Simulator

A lightweight, modular packet-level simulator for RotorNet datacenter networks, based on the SIGCOMM 2017 paper "RotorNet: A Scalable, Low-complexity, Optical Datacenter Network."

## Features

- **Flow Generation**: Implements published flow-size distributions from:
  - Microsoft Datamining workload (VL2 paper)
  - Microsoft Websearch workload (DCTCP paper)
  - Facebook Hadoop workload
  
- **RotorNet Topology**: 
  - Automatic generation of disjoint matchings
  - Cyclic reconfiguration with configurable switching times
  - Direct and indirect path routing
  
- **2-Hop Valiant Load Balancing (VLB)**:
  - Low-latency traffic always uses 2-hop paths through random intermediate racks
  - Bulk traffic preferentially waits for direct paths
  - Adaptive routing based on queue state
  
- **Virtual Output Queues (VOQs)**:
  - Separate queue per destination rack at each ToR
  - Prevents head-of-line blocking
  - Per-destination flow control

- **Flow File I/O**:
  - Save generated flows to CSV for reproducibility
  - Load pre-generated flows from file
  - Compatible with Opera-sim format (via converter utility)
  
- **Transport**:
  - Bulk traffic waits for direct paths (low bandwidth tax)
  - Low-latency traffic uses 2-hop VLB immediately
  - Configurable flow size threshold (default: 15 MB)
  
- **Statistics**:
  - Flow completion times (mean, median, percentiles)
  - Separate stats for bulk and low-latency flows
  - Throughput measurement
  - Packet drops

## File Structure

```
main.cpp                 # Entry point
config.h                 # Configuration management
flow.h                   # Flow and packet data structures
workload_generator.h     # Flow generation based on published distributions
topology.h               # RotorNet topology and matching management
voq.h                    # Virtual Output Queue management
simulator.h              # Main discrete-event simulation engine
stats.h                  # Statistics collection and reporting
flow_converter.cpp       # Utility to convert between Opera-sim and RotorNet formats
Makefile                 # Build system
README.md                # This file
```

## Building

```bash
# Standard optimized build
make

# Build the flow converter utility
g++ -std=c++17 -O3 flow_converter.cpp -o flow_converter

# Debug build with symbols
make debug

# Clean
make clean
```

## Usage

### Default Configuration

```bash
./rotornet_sim
```

### Custom Configuration File

Create a configuration file (e.g., `config.txt`):

```
num_racks 32
num_switches 8
hosts_per_rack 32
link_rate_gbps 10.0
load_factor 0.30
sim_time_ms 500.0
random_seed 42
workload datamining
save_flows true
flow_output_file my_flows.csv
```

Run with:
```bash
./rotornet_sim config.txt
```

### Using Pre-generated Flows

To reuse the same flow pattern across multiple simulations:

```bash
# First run: generate and save flows
./rotornet_sim config_with_save.txt

# Subsequent runs: load flows from file
# In config file, add: flow_file my_flows.csv
./rotornet_sim config_with_load.txt
```

### Opera-sim Compatibility

Convert between Opera-sim and RotorNet flow formats:

```bash
# Convert Opera-sim flows to RotorNet format
./flow_converter opera2rotor opera_flows.txt rotornet_flows.csv

# Convert RotorNet flows to Opera-sim format
./flow_converter rotor2opera rotornet_flows.csv opera_flows.txt
```

**Note**: Opera-sim uses global host IDs, while RotorNet uses (rack, host) pairs. The converter assumes 32 hosts per rack by default.

## Configuration Parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| `num_racks` | Number of ToR racks | 16 |
| `num_switches` | Number of circuit switches | 4 |
| `hosts_per_rack` | Hosts per rack | 32 |
| `link_rate_gbps` | Link bandwidth (Gb/s) | 10.0 |
| `load_factor` | Network load (0.0-1.0) | 0.25 |
| `sim_time_ms` | Simulation duration (ms) | 1000.0 |
| `random_seed` | Random seed | 42 |
| `workload` | Workload type: datamining, websearch, hadoop | datamining |
| `reconfig_delay_us` | Switch reconfiguration time (μs) | 20.0 |
| `duty_cycle` | Fraction of time switches are active | 0.9 |
| `queue_size_pkts` | VOQ size per destination (packets) | 100 |
| `save_flows` | Save generated flows to file | false |
| `flow_output_file` | Output file for generated flows | flows.csv |
| `flow_file` | Load flows from file (if set, skips generation) | "" |

## Output

The simulator produces:
1. **Console output**: Configuration, progress updates, and summary statistics
2. **CSV file** (`results.csv`): Key metrics for analysis

### Example Output

```
RotorNet Packet Simulator
=========================
Configuration:
  Racks: 16
  Switches: 4
  Hosts per rack: 32
  Link rate: 10 Gb/s
  Load factor: 0.25
  Simulation time: 1000 ms
  Workload: Datamining

Topology initialized:
  Matchings per switch: 4
  Slot time: 200.000 μs
  Cycle time: 3200.000 μs

Generated 1247 flows
Running simulation...
  Progress: 25.0%
  Progress: 50.0%
  Progress: 75.0%
  Progress: 100.0%
Simulation complete. Collecting statistics...

========== Simulation Results ==========

Flow Statistics:
  Total flows: 1247
  Completed flows: 1198 (96.1%)
  Dropped packets: 23

Flow Completion Times (all flows):
  Mean: 45.231 ms
  Median: 12.456 ms
  95th: 156.789 ms
  99th: 289.123 ms
  Max: 432.567 ms

Low-latency FCTs:
  Count: 1089
  Mean: 15.678 ms
  99th: 78.234 ms

Bulk FCTs:
  Count: 109
  Mean: 245.123 ms
  99th: 567.890 ms

Throughput:
  Average: 42.5 Gb/s

========================================
```

## Design Notes

### Key Implementation Details

1. **2-Hop VLB**: Low-latency flows always select a random intermediate rack at flow creation time. This ensures consistent routing and prevents reordering while leveraging spare capacity.

2. **VOQ Architecture**: Each rack maintains separate queues for each destination, preventing head-of-line blocking that would otherwise occur with a single shared queue.

3. **Bulk vs. Low-latency**: The distinction is made at flow creation based on size threshold. Packets inherit this classification and route accordingly.

4. **Direct Path Scheduling**: Bulk traffic waits for direct paths by checking topology state and scheduling transmission when circuits align.

### Simplifications vs. Full Implementation

This simulator makes several simplifying assumptions compared to a production implementation:

1. **Simplified VLB**: Uses random intermediate rack selection rather than sophisticated load-aware selection
2. **No congestion control**: Packets simply queue or drop (RotorLB protocol not fully implemented)
3. **Perfect synchronization**: No modeling of clock drift or synchronization overhead
4. **Simplified admission control**: Basic queue-based dropping rather than sophisticated flow control

### Opera-sim Compatibility

The flow format is **partially compatible** with Opera-sim:

- **Compatible**: Both use (src, dst, size, time) tuples
- **Different formats**: Opera-sim uses space-separated global host IDs; RotorNet uses CSV with rack/host separation
- **Converter provided**: Use `flow_converter` utility to translate between formats
- **Semantic compatibility**: Both represent the same underlying workloads, just with different encodings

The converter assumes 32 hosts per rack. Adjust this in `flow_converter.cpp` if your topology differs.

### Extending the Simulator

To add features:

- **Adaptive VLB**: Modify `handleFlowArrival()` to select intermediate racks based on queue state
- **Congestion control**: Add window-based flow control and RotorLB protocol
- **Better scheduling**: Implement more sophisticated VOQ scheduling policies in `startTransmission()`
- **Link failures**: Add failure events and dynamic topology updates
- **More workloads**: Add new CDFs in `WorkloadGenerator::getCDFForWorkload()`
- **Fine-grained stats**: Track per-hop delays, queue depths over time, etc.

### Flow File Format

**RotorNet CSV Format:**
```csv
flow_id,src_rack,dst_rack,src_host,dst_host,size_bytes,start_time_ms,flow_type
0,5,12,8,15,524288,0.123,low_latency
1,3,7,2,18,157286400,1.456,bulk
```

**Opera-sim Format:**
```
src_host_global dst_host_global size_bytes start_time_ns
168 399 524288 123000
98 242 157286400 1456000
```

Where `src_host_global = src_rack * hosts_per_rack + src_host`.

## References

1. Mellette et al., "RotorNet: A Scalable, Low-complexity, Optical Datacenter Network," SIGCOMM 2017
2. Mellette et al., "Expanding across time to deliver bandwidth efficiency and low latency (Opera)," NSDI 2020
3. Greenberg et al., "VL2: A Scalable and Flexible Data Center Network," SIGCOMM 2009
4. Alizadeh et al., "Data Center TCP (DCTCP)," SIGCOMM 2010
5. Roy et al., "Inside the Social Network's (Datacenter) Network," SIGCOMM 2015

## License

This simulator is provided for research and educational purposes.
